generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---

enum UserRole {
  PATIENT
  CLINIC
  OWNER
}

enum ActivationCodeStatus {
  ISSUED
  DRAFT
  APPROVED
  CLAIMED
  INVALIDATED
}

enum RecoveryPlanCategory {
  general_outpatient
  cosmetic_recovery
}

// --- MODELS ---

model User {
  id                     String    @id @default(uuid())
  email                  String    @unique
  passwordHash           String
  role                   UserRole  @default(PATIENT)
  clinicTag              String?   // For CLINIC users
  tokenVersion      Int      @default(1)
  
  // --- NEW SECURITY FIELDS ---
  failedLoginAttempts    Int       @default(0)
  lockedUntil            DateTime? // If set, user cannot login until this time
  lastLoginAt            DateTime?
  isBanned               Boolean   @default(false) // Instant termination switch
  // ---------------------------
   
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  // Onboarding
  consentAcceptedAt      DateTime?
  procedureName          String?
  procedureCode          String?                 // legacy compatibility
  recoveryStartDate      String?                 // YYYY-MM-DD

  // Verification
  emailVerifiedAt        DateTime?
  verificationCode       String?
  verificationExpiresAt  DateTime?

  // --- PASSWORD RESET FIELDS ---
  passwordResetTokenHash String?   @unique
  passwordResetExpiresAt DateTime?
  // -----------------------------

  // Relations
  logEntries             LogEntry[]
  claimedActivationCodes ActivationCode[]        @relation("ActivationCodeClaimedByUser")
   
  recoveryPlans          RecoveryPlanInstance[] 
   
  createdActivationBatches ActivationBatch[]       @relation("ActivationBatchCreatedBy")
  capturedActivationConfigs ActivationCode[]       @relation("ActivationCodeConfigCapturedByUser")

  @@index([clinicTag])
}

model LogEntry {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
   
  date          String   // YYYY-MM-DD
  painLevel     Int
  swellingLevel Int
  notes         String?  @db.Text
   
  schemaVersion Int      @default(2)
  details       Json?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId, date])
}

model ClinicPlanConfig {
  clinicTag        String                @id
  defaultCategory  RecoveryPlanCategory  @default(general_outpatient)
  overridesJson    Json?
  notes            String?

  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt

  activationCodes  ActivationCode[]
  templates        RecoveryPlanTemplate[]
}

model ActivationBatch {
  id              String           @id @default(uuid())
  clinicTag       String?
  quantity        Int
   
  createdByUserId String?
  createdByUser   User?            @relation("ActivationBatchCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
   
  codes           ActivationCode[]
  createdAt       DateTime         @default(now())

  @@index([clinicTag])
  @@index([createdByUserId])
}

model ActivationCode {
  id                     String                @id @default(uuid())
  code                   String                @unique
  status                 ActivationCodeStatus  @default(ISSUED)
   
  clinicTag              String?
  clinicConfig           ClinicPlanConfig?     @relation(fields: [clinicTag], references: [clinicTag])
   
  batchId                String?
  batch                  ActivationBatch?      @relation(fields: [batchId], references: [id], onDelete: SetNull)

  // Clinic flow
  configJson             Json?
  planSnapshot           Json?
  configCapturedAt       DateTime?
  configCapturedByUserId String?
  configCapturedByUser   User?                 @relation("ActivationCodeConfigCapturedByUser", fields: [configCapturedByUserId], references: [id], onDelete: SetNull)

  // Patient flow
  claimedByUserId        String?
  claimedByUser          User?                 @relation("ActivationCodeClaimedByUser", fields: [claimedByUserId], references: [id], onDelete: SetNull)
  claimedAt              DateTime?

  planInstance           RecoveryPlanInstance?

  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt

  @@index([status])
  @@index([clinicTag])
  @@index([claimedByUserId])
  @@index([batchId])
  @@index([configCapturedByUserId])
}

model RecoveryPlanTemplate {
  id           String               @id @default(uuid())
   
  clinicTag    String?              
  clinic       ClinicPlanConfig?    @relation(fields: [clinicTag], references: [clinicTag], onDelete: Cascade)

  category     RecoveryPlanCategory
  version      Int
  title        String
  planJson     Json
  sourcesJson  Json?

  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  instances    RecoveryPlanInstance[]

  @@unique([clinicTag, category, version])
  @@index([category])
  @@index([clinicTag])
}

model RecoveryPlanInstance {
  id               String               @id @default(uuid())
  userId           String
   
  user             User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  activationCodeId String               @unique
  activationCode   ActivationCode       @relation(fields: [activationCodeId], references: [id], onDelete: Cascade)

  templateId       String
  template         RecoveryPlanTemplate @relation(fields: [templateId], references: [id], onDelete: Restrict)

  engineVersion    String
  startDate        String

  configJson       Json
  planJson         Json

  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  @@index([userId])
  @@index([startDate])
}

model SecurityAudit {
  id               String   @id @default(uuid())
  actorUserId      String?
  actorRole        String
  eventCategory    String
  eventType        String
   
  clinicTag        String?
  patientUserId    String?
   
  targetObjectType String?
  targetObjectId   String?  
   
  ipAddress        String
  userAgent        String
  status           String
  metadata         Json?
   
  timestamp        DateTime @default(now())

  @@index([timestamp])
  @@index([actorUserId])
  @@index([clinicTag])
}