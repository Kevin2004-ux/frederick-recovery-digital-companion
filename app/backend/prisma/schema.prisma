generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ActivationCodeStatus {
  UNUSED
  CLAIMED
}

enum RecoveryPlanCategory {
  general_outpatient
  cosmetic_recovery
}

model User {
  id                    String   @id @default(uuid())
  email                 String   @unique
  passwordHash          String

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // consent + onboarding
  consentAcceptedAt     DateTime?

  // canonical + legacy
  procedureName         String?
  procedureCode         String?  // legacy compatibility
  recoveryStartDate     String?  // keep as YYYY-MM-DD string

  // email verification
  emailVerifiedAt       DateTime?
  verificationCode      String?
  verificationExpiresAt DateTime?

  logEntries            LogEntry[]

  // NEW: activation + plan
  claimedActivationCodes ActivationCode[] @relation("ActivationCodeClaimedByUser")
  recoveryPlanInstances  RecoveryPlanInstance[]
}

model LogEntry {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  date          String   // YYYY-MM-DD (string avoids timezone bugs)

  painLevel     Int
  swellingLevel Int
  notes         String?

  schemaVersion Int      @default(1)
  details       Json?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId, date])
}

//
// NEW MODELS â€” Recovery Plan Expansion
//

model ClinicPlanConfig {
  // Non-PHI clinic identifier used to influence plan generation
  clinicTag       String              @id

  // Default template category for this clinic (can be overridden later)
  defaultCategory RecoveryPlanCategory @default(general_outpatient)

  // Non-PHI overrides to tweak templates (structured toggles / params)
  // Example: { "noNSAIDs": true, "compressionDays": 7, "showDrainCare": true }
  overridesJson   Json?

  // Optional non-PHI notes for internal operational use (avoid free-text if possible)
  notes           String?

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  activationCodes ActivationCode[]
}

model ActivationCode {
  id              String              @id @default(uuid())

  // What patient enters
  code            String              @unique

  status          ActivationCodeStatus @default(UNUSED)

  // Non-PHI clinic identifier
  clinicTag       String?
  clinicConfig    ClinicPlanConfig?   @relation(fields: [clinicTag], references: [clinicTag])

  // Claim linkage
  claimedByUserId String?
  claimedByUser   User?               @relation("ActivationCodeClaimedByUser", fields: [claimedByUserId], references: [id], onDelete: SetNull)
  claimedAt       DateTime?

  // One activation code should map to at most one plan instance
  planInstance    RecoveryPlanInstance?

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([status])
  @@index([clinicTag])
  @@index([claimedByUserId])
}

model RecoveryPlanTemplate {
  id           String              @id @default(uuid())

  category     RecoveryPlanCategory
  version      Int

  title        String

  // Template content (educational day-by-day JSON)
  planJson     Json

  // Source links (MedlinePlus, etc.)
  sourcesJson  Json?

  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  instances    RecoveryPlanInstance[]

  @@unique([category, version])
  @@index([category])
}

model RecoveryPlanInstance {
  id               String              @id @default(uuid())

  userId           String
  user             User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  activationCodeId String              @unique
  activationCode   ActivationCode      @relation(fields: [activationCodeId], references: [id], onDelete: Cascade)

  templateId       String
  template         RecoveryPlanTemplate @relation(fields: [templateId], references: [id], onDelete: Restrict)

  // Lets us evolve generation logic without breaking old instances
  engineVersion    String

  // Date-only string (YYYY-MM-DD) to align with LogEntry date style
  startDate        String

  // Generated copy (template + clinic overrides resolved + any safe patient prefs)
  planJson         Json

  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  @@index([userId])
  @@index([startDate])
}
