generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  PATIENT
  CLINIC
}

enum ActivationCodeStatus {
  UNUSED
  CLAIMED
}

enum RecoveryPlanCategory {
  general_outpatient
  cosmetic_recovery
}

model User {
  id                    String   @id @default(uuid())
  email                 String   @unique
  passwordHash          String

  // role-based auth (doctor/clinic users are CLINIC)
  role                  UserRole @default(PATIENT)

  // NEW: clinic identity for CLINIC users (enables ownership enforcement on activation codes)
  clinicTag             String?

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // consent + onboarding
  consentAcceptedAt     DateTime?

  // canonical + legacy
  procedureName         String?
  procedureCode         String?  // legacy compatibility
  recoveryStartDate     String?  // keep as YYYY-MM-DD string

  // email verification
  emailVerifiedAt       DateTime?
  verificationCode      String?
  verificationExpiresAt DateTime?

  logEntries            LogEntry[]

  // activation + plan
  claimedActivationCodes ActivationCode[] @relation("ActivationCodeClaimedByUser")
  recoveryPlanInstances  RecoveryPlanInstance[]

  // audit links (optional)
  createdActivationBatches   ActivationBatch[] @relation("ActivationBatchCreatedBy")
  capturedActivationConfigs  ActivationCode[] @relation("ActivationCodeConfigCapturedByUser")

  @@index([clinicTag])
}

model LogEntry {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  date          String   // YYYY-MM-DD (string avoids timezone bugs)

  painLevel     Int
  swellingLevel Int
  notes         String?

  schemaVersion Int      @default(1)
  details       Json?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId, date])
}

model ClinicPlanConfig {
  clinicTag       String               @id
  defaultCategory RecoveryPlanCategory  @default(general_outpatient)
  overridesJson   Json?
  notes           String?

  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  activationCodes ActivationCode[]
}

model ActivationBatch {
  id              String    @id @default(uuid())

  clinicTag        String?
  quantity         Int

  createdByUserId  String?
  createdByUser    User?     @relation("ActivationBatchCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  codes            ActivationCode[]

  createdAt        DateTime  @default(now())

  @@index([clinicTag])
  @@index([createdByUserId])
}

model ActivationCode {
  id              String               @id @default(uuid())
  code            String               @unique
  status          ActivationCodeStatus @default(UNUSED)

  clinicTag       String?
  clinicConfig    ClinicPlanConfig?    @relation(fields: [clinicTag], references: [clinicTag])

  // batch linkage
  batchId         String?
  batch           ActivationBatch?     @relation(fields: [batchId], references: [id], onDelete: SetNull)

  // doctor-first workflow (categorical, non-PHI)
  configJson              Json?
  configCapturedAt        DateTime?
  configCapturedByUserId  String?
  configCapturedByUser    User?        @relation("ActivationCodeConfigCapturedByUser", fields: [configCapturedByUserId], references: [id], onDelete: SetNull)

  // Claim linkage
  claimedByUserId String?
  claimedByUser   User?                @relation("ActivationCodeClaimedByUser", fields: [claimedByUserId], references: [id], onDelete: SetNull)
  claimedAt       DateTime?

  planInstance    RecoveryPlanInstance?

  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  @@index([status])
  @@index([clinicTag])
  @@index([claimedByUserId])
  @@index([batchId])
  @@index([configCapturedByUserId])
}

model RecoveryPlanTemplate {
  id           String               @id @default(uuid())

  category     RecoveryPlanCategory
  version      Int
  title        String
  planJson     Json
  sourcesJson  Json?

  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  instances    RecoveryPlanInstance[]

  @@unique([category, version])
  @@index([category])
}

model RecoveryPlanInstance {
  id               String               @id @default(uuid())

  userId           String
  user             User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  activationCodeId String               @unique
  activationCode   ActivationCode       @relation(fields: [activationCodeId], references: [id], onDelete: Cascade)

  templateId       String
  template         RecoveryPlanTemplate  @relation(fields: [templateId], references: [id], onDelete: Restrict)

  engineVersion    String
  startDate        String

  // categorical non-PHI config used to generate the plan
  configJson       Json
  planJson         Json

  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  @@index([userId])
  @@index([startDate])
}
